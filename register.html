<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ลงทะเบียนพนักงาน</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f0f2f5; margin: 0; padding: 1rem; display: flex; justify-content: center; align-items: center; min-height: 100vh; box-sizing: border-box; }
        .card { background-color: #ffffff; border-radius: 8px; padding: 1.5rem; width: 100%; max-width: 500px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .view-title { font-size: 1.5rem; font-weight: 700; text-align: center; margin-bottom: 1.5rem; color: #333; }
        form { display: flex; flex-direction: column; gap: 1rem; }
        .form-group label { font-weight: 500; margin-bottom: 0.25rem; color: #555; }
        .form-group input, .form-group select { width: 100%; padding: 0.75rem; border: 1px solid #e0e0e0; border-radius: 6px; font-family: 'Kanit', sans-serif; font-size: 1rem; box-sizing: border-box; }
        .btn { width: 100%; padding: 1rem; border-radius: 8px; border: none; font-size: 1rem; font-weight: 700; cursor: pointer; transition: background-color: 0.2s; }
        .btn-submit { background-color: #06C755; color: white; margin-top: 1rem; }
        .btn-submit:disabled { background-color: #cccccc; }
        #loading-view { text-align: center; }
        .spinner { border: 4px solid rgba(0,0,0,0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #06C755; animation: spin 1s linear infinite; margin: 2rem auto; }
        .hidden { display: none !important; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* --- CSS สำหรับ Custom Popup (แก้ไขใหม่) --- */
        #custom-alert-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        #custom-alert-box { background-color: white; padding: 2rem; border-radius: 12px; text-align: center; width: 80%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        #custom-alert-title { margin-top: 0; font-size: 1.25rem; font-weight: 700; }
        #custom-alert-message { font-size: 1rem; color: #555; margin-bottom: 1.5rem; white-space: pre-wrap; text-align: left; }
        #custom-alert-buttons { display: flex; gap: 0.75rem; margin-top: 1.5rem; }
        #custom-alert-buttons .btn-secondary { background-color: #6c757d; }
    </style>
</head>
<body>
    <div id="loading-view"><div class="spinner"></div><p>กำลังเตรียมหน้าลงทะเบียน...</p></div>

    <div id="register-form-container" class="card hidden">
        <h2 class="view-title">ลงทะเบียนพนักงานใหม่</h2>
        <p style="text-align: center; margin-top: -1rem; margin-bottom: 1.5rem; color: #777;">กรุณากรอกข้อมูลของคุณเพื่อเริ่มใช้งานระบบ</p>
        <form id="register-form">
            <div class="form-group"><label for="fullName">ชื่อ - นามสกุล</label><input type="text" id="fullName" placeholder="เช่น สมชาย ใจดี"></div>
            <div class="form-group"><label for="licensePlate">ทะเบียนรถ</label><input type="text" id="licensePlate" placeholder="เช่น 1กก-9999 กทม"></div>
            <div class="form-group"><label for="contactNumber">เบอร์ติดต่อ</label><input type="tel" id="contactNumber" placeholder="เช่น 0909999999"></div>
            <div class="form-group"><label for="branch">สาขา</label><select id="branch"><option value="" disabled selected>-- กรุณาเลือกสาขา --</option></select></div>
            <button type="submit" class="btn-submit">ลงทะเบียน</button>
        </form>
    </div>

    <!-- --- HTML สำหรับ Custom Popup (แก้ไขใหม่) --- -->
    <div id="custom-alert-overlay" class="hidden">
        <div id="custom-alert-box">
            <h3 id="custom-alert-title"></h3>
            <p id="custom-alert-message"></p>
            <div id="custom-alert-buttons">
                <button id="custom-alert-cancel-btn" class="btn btn-secondary">ยกเลิก</button>
                <button id="custom-alert-confirm-btn" class="btn btn-primary">ยืนยัน</button>
                <button id="custom-alert-close-btn" class="btn btn-primary">ตกลง</button>
            </div>
        </div>
    </div>

  // <script> (สำหรับ register.html)

const LIFF_ID = '2008492672-NdaLDanK'; 
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzwDN253O2M4VNRLnlUktsZKvt5LWfJ1qh1mYE2uTjP5MN5XWM_h4gW7gqqg9fQaTWZ/exec';

let liffProfile = null;

async function main() {
    try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        liffProfile = await liff.getProfile();
        
        const branches = await serverCall('getBranchList');
        populateBranchDropdown(branches);
        
        document.getElementById('loading-view').classList.add('hidden');
        document.getElementById('register-form-container').classList.remove('hidden');
    } catch (error) {
        showCustomAlert('เกิดข้อผิดพลาด', error.message, false);
        document.getElementById('loading-view').classList.add('hidden');
    }
}

main();

function populateBranchDropdown(branches) {
    const selectElement = document.getElementById('branch');
    if (branches && branches.length > 0) {
        branches.forEach(branchObj => {
            const option = document.createElement('option');
            option.value = branchObj.BranchName;
            option.textContent = branchObj.BranchName;
            selectElement.appendChild(option);
        });
    }
}

document.getElementById('register-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = e.target;
    
    const requiredFields = [
        { id: 'fullName', name: 'ชื่อ - นามสกุล' },
        { id: 'licensePlate', name: 'ทะเบียนรถ' },
        { id: 'contactNumber', name: 'เบอร์ติดต่อ' },
        { id: 'branch', name: 'สาขา' },
    ];
    for (const field of requiredFields) {
        const input = form.querySelector(`#${field.id}`);
        if (!input.value) {
            showCustomAlert('ข้อมูลไม่ครบถ้วน', `กรุณาเลือกหรือกรอกข้อมูล "${field.name}"`, false);
            return;
        }
    }
    
    const data = {
        userId: liffProfile.userId,
        'ชื่อ - นามสกุล': document.getElementById('fullName').value,
        'ทะเบียนรถ': document.getElementById('licensePlate').value,
        'เบอร์ติดต่อ': document.getElementById('contactNumber').value,
        'สาขา': document.getElementById('branch').value
    };

    let confirmationMessage = "กรุณาตรวจสอบข้อมูล:\n\n";
    confirmationMessage += `ชื่อ-สกุล: ${data['ชื่อ - นามสกุล']}\n`;
    confirmationMessage += `ทะเบียนรถ: ${data['ทะเบียนรถ']}\n`;
    confirmationMessage += `เบอร์ติดต่อ: ${data['เบอร์ติดต่อ']}\n`;
    confirmationMessage += `สาขา: ${data['สาขา']}`;

    showConfirmationPopup('ยืนยันการลงทะเบียน', confirmationMessage, async () => {
        document.getElementById('register-form-container').classList.add('hidden');
        document.getElementById('loading-view').classList.remove('hidden');
        document.querySelector('#loading-view p').textContent = 'กำลังลงทะเบียน...';

        try {
            const result = await serverCall('registerEmployee', data);
            document.getElementById('loading-view').classList.add('hidden');
            showCustomAlert(`คุณ ${liffProfile.displayName}`, result.message, true);
        } catch (error) {
            document.getElementById('loading-view').classList.add('hidden');
            document.getElementById('register-form-container').classList.remove('hidden');
            showCustomAlert('เกิดข้อผิดพลาด', error.message, false);
        }
    });
});

function serverCall(action, ...args) {
    const url = GAS_WEB_APP_URL;
    const payload = { action: action, args: args };
    return fetch(url, {
        method: 'POST',
        body: JSON.stringify(payload),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        mode: 'cors'
    })
    .then(response => response.json())
    .then(data => { if (data.status === 'error') { throw new Error(data.message); } return data.response; });
}

// ★★★★★★★★★★★★★★★★★★ ฟังก์ชัน Popup ทั้งหมด (ฉบับเต็ม) ★★★★★★★★★★★★★★★★★★
let countdownInterval;
function showCustomAlert(title, message, isSuccess = false) {
    const overlay = document.getElementById('custom-alert-overlay');
    const titleEl = document.getElementById('custom-alert-title');
    const messageEl = document.getElementById('custom-alert-message');
    const confirmBtn = document.getElementById('custom-alert-confirm-btn');
    const cancelBtn = document.getElementById('custom-alert-cancel-btn');
    const closeBtn = document.getElementById('custom-alert-close-btn');

    titleEl.textContent = title;
    messageEl.textContent = message;
    messageEl.style.whiteSpace = 'pre-wrap';

    confirmBtn.classList.add('hidden');
    cancelBtn.classList.add('hidden');
    closeBtn.classList.remove('hidden');

    overlay.classList.remove('hidden');
    clearInterval(countdownInterval);

    if (isSuccess) {
        let countdown = 5;
        closeBtn.textContent = `ตกลง (ไปหน้าหลักใน ${countdown} วิ)`;
        countdownInterval = setInterval(() => {
            countdown--;
            if (countdown > 0) {
                closeBtn.textContent = `ตกลง (ไปหน้าหลักใน ${countdown} วิ)`;
            } else {
                clearInterval(countdownInterval);
                closeAndExit();
            }
        }, 1000);
    } else {
        closeBtn.textContent = 'ตกลง';
    }

    closeBtn.onclick = () => {
        clearInterval(countdownInterval);
        if (isSuccess) {
            closeAndExit();
        } else {
            overlay.classList.add('hidden');
        }
    };
}

function showConfirmationPopup(title, message, onConfirm) {
    const overlay = document.getElementById('custom-alert-overlay');
    const titleEl = document.getElementById('custom-alert-title');
    const messageEl = document.getElementById('custom-alert-message');
    const confirmBtn = document.getElementById('custom-alert-confirm-btn');
    const cancelBtn = document.getElementById('custom-alert-cancel-btn');
    const closeBtn = document.getElementById('custom-alert-close-btn');

    titleEl.textContent = title;
    messageEl.textContent = message;
    messageEl.style.whiteSpace = 'pre-wrap';

    confirmBtn.classList.remove('hidden');
    cancelBtn.classList.remove('hidden');
    closeBtn.classList.add('hidden');
    
    overlay.classList.remove('hidden');

    confirmBtn.onclick = () => {
        overlay.classList.add('hidden');
        onConfirm();
    };

    cancelBtn.onclick = () => {
        overlay.classList.add('hidden');
    };
}

function closeAndExit() {
    document.getElementById('custom-alert-overlay').classList.add('hidden');
    // หลังจากลงทะเบียน ให้ไปที่ index.html เสมอ
    window.location.href = './index.html';
}


